<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Scores Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .nav-bar {
            margin-bottom: 20px;
        }
        .nav-bar a {
            margin-right: 15px;
            padding: 10px;
            text-decoration: none;
            color: black;
            border: 1px solid black;
            border-radius: 5px;
        }
        .nav-bar a.active {
            background-color: #f2f2f2;
        }
        .score-table img {
            width: 50px;
            height: 50px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
    </style>
    <script>
        function showTable(diff) {
            const tables = document.querySelectorAll('.score-table');
            tables.forEach(table => {
                table.style.display = (table.id === diff) ? 'table' : 'none';
            });
            const charts = document.querySelectorAll('.chart-container');
            charts.forEach(chart => {
                chart.style.display = (chart.id === diff) ? 'table' : 'none';
            });

            const navLinks = document.querySelectorAll('.nav-bar a');
            navLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('data-diff') === diff);
            });

        }

        function parseScore(scoreStr) {
            return parseInt(scoreStr.replace(/,/g, ''), 10);
        }

        function calculateRating(score, baseRating) {
            if (score >= 1009000) {
                return baseRating + 2.15;
            } else if (score >= 1007500) {
                return baseRating + 2.0 + ((score - 1007500) * 0.15) / 1500;
            } else if (score >= 1005000) {
                return baseRating + 1.5 + ((score - 1005000) * 0.5) / 2500;
            } else if (score >= 1000000) {
                return baseRating + 1.0 + ((score - 1000000) * 0.5) / 5000;
            } else if (score >= 975000) {
                return baseRating;
            } else if (score >= 925000) {
                return baseRating - 3.0;
            } else if (score >= 900000) {
                return baseRating - 5.0;
            } else if (score >= 800000) {
                return (baseRating - 5.0) / 2;
            } else {
                return 0;
            }
        }

        function insertRatings() {
            const tables = document.querySelectorAll('.score-table');
            tables.forEach(table => {
                const rows = Array.from(table.querySelectorAll('tbody tr'));
                rows.forEach(row => {
                    const score = parseScore(row.querySelector('.score').textContent);
                    const baseRating = parseFloat(row.querySelector('.base-rating').textContent);
                    const rating = calculateRating(score, baseRating);
                    row.querySelector('.rating').textContent = rating.toFixed(2);
                });

                // Sort rows by rating in descending order
                rows.sort((a, b) => {
                    const ratingA = parseFloat(a.querySelector('.rating').textContent);
                    const ratingB = parseFloat(b.querySelector('.rating').textContent);
                    return ratingB - ratingA;
                });

                // Append sorted rows back to the table
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            });
        }

         function updateCharts() {
            const difficulties = ["Basic", "Advanced", "Expert", "Master", "Ultima"];
            const allData = [];

            difficulties.forEach(diff => {
                const table = document.getElementById(diff);
                if (!table) return;

                const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => parseScore(row.querySelector('.score').textContent) > 0);
                rows.forEach(row => {
                    const songTitle = row.querySelector('.music_title').textContent; // 假設有一個 class 為 .music_title 的元素包含歌曲標題
                    const baseRating = row.querySelector('.base-rating').textContent;
                    const score = parseScore(row.querySelector('.score').innerText);
                    const images = row.querySelector('img').src;

                    allData.push({
                        diff,
                        music_title: songTitle,
                        base_rating: baseRating,
                        score: score,
                        images: images
                    });
                });
            });
            const filteredData = allData.filter(item => item.base_rating === '14.5');
            if (filteredData.length > 0) {
                document.getElementById('Chart-14+').style.display = 'block';
                drawChart(filteredData);
            }

            console.log(); // 在這裡您可以處理或顯示所有合併的數據

        }
         function drawChart(data) {
            const diffColors = {
                "Basic": 'rgba(75, 192, 192, 0.2)',  // 綠色
                "Advanced": 'rgba(255, 206, 86, 0.2)',  // 黃色
                "Expert": 'rgba(255, 99, 132, 0.2)',  // 紅色
                "Master": 'rgba(153, 102, 255, 0.2)',  // 紫色
                "Ultima": 'rgba(0, 0, 0, 0.2)'  // 黑色
            };

            const borderColor = {
                "Basic": 'rgba(75, 192, 192, 1)',  // 綠色
                "Advanced": 'rgba(255, 206, 86, 1)',  // 黃色
                "Expert": 'rgba(255, 99, 132, 1)',  // 紅色
                "Master": 'rgba(153, 102, 255, 1)',  // 紫色
                "Ultima": 'rgba(0, 0, 0, 1)'  // 黑色
            };

            const filteredData = data.filter(item => item.score >= 950000);
            filteredData.sort((a, b) => a.score - b.score);

            const ctx = document.getElementById('chartCanvas').getContext('2d');
            const minY = Math.max(0, Math.min(...filteredData.map(item => item.score)) - 100);

            new Chart(ctx, {
                type: 'bar', // 您可以根據需要更改圖表類型
                data: {
                    labels: filteredData.map(item => item.music_title),
                    datasets: [{
                        label: 'Score',
                        data: filteredData.map(item => item.score),
                        backgroundColor: filteredData.map(item => diffColors[item.diff]),
                        borderColor: filteredData.map(item => borderColor[item.diff]),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: minY
                        }
                    }
                }
            });
        }

        window.onload = function() {
            // Default to show "Basic" difficulty
            showTable('Master');
            // Insert ratings after the page has loaded
            insertRatings();
            updateCharts();
        }
    </script>
</head>
<body>
    <h1>Music Scores Table</h1>
    <div class="nav-bar">
        {% set difficulties = ["Basic", "Advanced", "Expert", "Master", "Ultima", "Recent", "B30", "Chart-1~10+","Chart-11~12+","Chart-13","Chart-13+","Chart-14","Chart-14+","Chart-15"] %}
        {% for diff in difficulties %}
            <a href="javascript:void(0)" data-diff="{{ diff }}" onclick="showTable('{{ diff }}')">{{ diff }}</a>
        {% endfor %}
    </div>

    {% for diff in difficulties %}
        {% if diff in file_content %}
            <table id="{{ diff }}" class="score-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Music Images</th>
                        <th>Music Title</th>
                        <th>High Score</th>
                        <th>定数</th>
                        <th>評分</th>
                    </tr>
                </thead>
                <tbody>
                    {% for score in file_content[diff] %}
                        <tr>
                            <td><img src="{{ score.images }}" alt="{{ score.music_title }} image"></td>
                            <td class="music_title">{{ score.music_title }}</td>
                            <td class="score">{{ score.high_score }}</td>
                            <td class="base-rating">{{ score.const }}</td>
                            <td class="rating"></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    {% endfor %}
    <div id="Chart-1~10+" class="chart-container"></div>
    <div id="Chart-11~12+" class="chart-container"></div>
    <div id="Chart-13" class="chart-container"></div>
    <div id="Chart-13+" class="chart-container"></div>
    <div id="Chart-14" class="chart-container"></div>
    <div id="Chart-14+" class="chart-container">
        <canvas id="chartCanvas"></canvas>
    </div>
    <div id="Chart-15" class="chart-container"></div>
</body>
</html>
