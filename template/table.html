<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Scores Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .nav-bar {
            margin-bottom: 20px;
        }
        .nav-bar a {
            margin-right: 15px;
            padding: 10px;
            text-decoration: none;
            color: black;
            border: 1px solid black;
            border-radius: 5px;
        }
        .nav-bar a.active {
            background-color: #f2f2f2;
        }
        .score-table img {
            width: 50px;
            height: 50px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
    </style>
    <script>
        function showTable(diff) {
            const tables = document.querySelectorAll('.score-table');
            tables.forEach(table => {
                table.style.display = (table.id === diff) ? 'table' : 'none';
            });

            const navLinks = document.querySelectorAll('.nav-bar a');
            navLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('data-diff') === diff);
            });

            updateCharts(diff);
        }

        function parseScore(scoreStr) {
            return parseInt(scoreStr.replace(/,/g, ''), 10);
        }

        function calculateRating(score, baseRating) {
            if (score >= 1009000) {
                return baseRating + 2.15;
            } else if (score >= 1007500) {
                return baseRating + 2.0 + ((score - 1007500) * 0.15) / 1500;
            } else if (score >= 1005000) {
                return baseRating + 1.5 + ((score - 1005000) * 0.5) / 2500;
            } else if (score >= 1000000) {
                return baseRating + 1.0 + ((score - 1000000) * 0.5) / 5000;
            } else if (score >= 975000) {
                return baseRating;
            } else if (score >= 925000) {
                return baseRating - 3.0;
            } else if (score >= 900000) {
                return baseRating - 5.0;
            } else if (score >= 800000) {
                return (baseRating - 5.0) / 2;
            } else {
                return 0;
            }
        }

        function insertRatings() {
            const tables = document.querySelectorAll('.score-table');
            tables.forEach(table => {
                const rows = Array.from(table.querySelectorAll('tbody tr'));
                rows.forEach(row => {
                    const score = parseScore(row.querySelector('.score').textContent);
                    const baseRating = parseFloat(row.querySelector('.base-rating').textContent);
                    const rating = calculateRating(score, baseRating);
                    row.querySelector('.rating').textContent = rating.toFixed(2);
                });

                // Sort rows by rating in descending order
                rows.sort((a, b) => {
                    const ratingA = parseFloat(a.querySelector('.rating').textContent);
                    const ratingB = parseFloat(b.querySelector('.rating').textContent);
                    return ratingB - ratingA;
                });

                // Append sorted rows back to the table
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            });
        }

        function updateCharts(diff) {
            const table = document.getElementById(diff);
            if (!table) return;

            const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => parseScore(row.querySelector('.score').textContent) > 0);
            const groupedByRating = rows.reduce((acc, row) => {
                const baseRating = row.querySelector('.base-rating').textContent;
                if (!acc[baseRating]) acc[baseRating] = [];
                acc[baseRating].push(row);
                return acc;
            }, {});

            // Clear previous charts
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = '';

            Object.keys(groupedByRating).forEach(baseRating => {
                const ratingRows = groupedByRating[baseRating];
                const labels = ratingRows.map(row => row.querySelector('td:nth-child(2)').textContent); // Music Title
                const scores = ratingRows.map(row => parseScore(row.querySelector('.score').textContent));

                const minScore = Math.min(...scores);
                const maxScore = Math.max(...scores);

                const canvas = document.createElement('canvas');
                chartContainer.appendChild(canvas);
                const ctx = canvas.getContext('2d');

                new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Base Rating ${baseRating} vs. Scores`,
                            data: scores.map((score, index) => ({ x: index, y: score })),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: scores.map(score => score >= 1000000 ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)'),
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                min: minScore,
                                max: maxScore,
                                title: {
                                    display: true,
                                    text: 'Score'
                                }
                            },
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: 'Music Title'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return labels[value];
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        return `${labels[index]}: ${scores[index]}`;
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        window.onload = function() {
            // Default to show "Basic" difficulty
            showTable('Master');
            // Insert ratings after the page has loaded
            insertRatings();
        }
    </script>
</head>
<body>
    <h1>Music Scores Table</h1>
    <div class="nav-bar">
        {% set difficulties = ["Basic", "Advanced", "Expert", "Master", "Ultima", "Recent", "B30", "Chart"] %}
        {% for diff in difficulties %}
            <a href="javascript:void(0)" data-diff="{{ diff }}" onclick="showTable('{{ diff }}')">{{ diff }}</a>
        {% endfor %}
    </div>

    {% for diff in difficulties %}
        {% if diff in file_content %}
            <table id="{{ diff }}" class="score-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Music Images</th>
                        <th>Music Title</th>
                        <th>High Score</th>
                        <th>定数</th>
                        <th>評分</th>
                    </tr>
                </thead>
                <tbody>
                    {% for score in file_content[diff] %}
                        <tr>
                            <td><img src="{{ score.images }}" alt="{{ score.music_title }} image"></td>
                            <td>{{ score.music_title }}</td>
                            <td class="score">{{ score.high_score }}</td>
                            <td class="base-rating">{{ score.const }}</td>
                            <td class="rating"></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    {% endfor %}

    <div id="chart-container" class="chart-container"></div>
</body>
</html>
